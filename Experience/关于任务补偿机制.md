## 前言

最近写了个定时任务，最开始是每秒执行一次，有大量的任务创建时，每秒都会向一个“脆弱”的服务器发送一个请求，积少成多，导致那个服务器老是崩。

崩了以后任务就执行失败了，后来我们又新增了一个任务重试机制，即记录失败次数和失败时间，在一定范围内的失败次数和失败时间是允许的，会再次重试任务。

但是这么做也是有缺陷的，因为那个服务器修复的时间不一定，可能在修复之前，该任务就已经用光了失败次数，导致该任务不会再被执行。

## 怎样写一个更灵敏的重试机制呢

### 想法1

在进行任务执行之前，先向服务器发送一个请求，看看服务器是否还在正常运行

在请求过程中，写一个flag，如果服务器返回的参数是“连接失败”，那么就先停止执行定时任务，等待服务器修复再继续执行定时任务。

这个flag可以存储在redis，然后设置一个新接口，手动重置flag（删除或更新都可以）

### 想法2

为了防止并发，我们可以给任务加一个锁，任务执行完成后解锁，任务执行中不允许执行其它任务。

执行任务失败时，执行下一条任务，等所有任务都执行完，再重新执行未成功执行的任务。

具体流程可以如流程图所示：

![image](任务执行流程.png)

### 想法3

当场景是：任务创建半小时后，若还是未执行成功，则执行第二次。

使用队列。

https://mp.weixin.qq.com/s/OmbyxkufVm-XzwIv_A514w
